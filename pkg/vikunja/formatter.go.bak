package vikunja

import (
	"bytes"
	"encoding/json"
	"fmt"
	"io"
	"strings"
	"text/tabwriter"
	"time"

	"github.com/fatih/color"
)

// Formatter handles output formatting for CLI
type Formatter struct {
	useColor bool
	output   io.Writer
}

// NewFormatter creates a new formatter
func NewFormatter(useColor bool, output io.Writer) *Formatter {
	return &Formatter{
		useColor: useColor,
		output:   output,
	}
}

// FormatProjects formats a list of projects as a table
func (f *Formatter) FormatProjects(projects []Project) error {
	if f.useColor {
		headerColor := color.New(color.FgCyan, color.Bold)
		_, _ = fmt.Fprintln(f.output, headerColor.Sprint("PROJECTS"))
		_, _ = fmt.Fprintln(f.output)
	}

	w := tabwriter.NewWriter(f.output, 0, 0, 3, ' ', 0)

	if f.useColor {
		headerColor := color.New(color.FgYellow, color.Bold)
		_, _ = fmt.Fprintln(w, headerColor.Sprint("NAME")+"\t"+headerColor.Sprint("ID")+"\t"+headerColor.Sprint("URI"))
	} else {
		_, _ = fmt.Fprintln(w, "NAME\tID\tURI")
	}

	for _, p := range projects {
		uri := fmt.Sprintf("vikunja://projects/%d", p.ID)
		fmt.Fprintf(w, "%s\t%d\t%s\n", p.Title, p.ID, uri)
	}

	return w.Flush()
}

// FormatProject formats a single project with full details
func (f *Formatter) FormatProject(project *Project) error {
	if f.useColor {
		titleColor := color.New(color.FgCyan, color.Bold)
		labelColor := color.New(color.FgYellow)
		fmt.Fprintf(f.output, "%s\n\n", titleColor.Sprint(project.Title))
		fmt.Fprintf(f.output, "%s %d\n", labelColor.Sprint("ID:"), project.ID)
		fmt.Fprintf(f.output, "%s %s\n", labelColor.Sprint("URI:"), fmt.Sprintf("vikunja://projects/%d", project.ID))
		if project.Description != "" {
			fmt.Fprintf(f.output, "\n%s\n%s\n", labelColor.Sprint("Description:"), project.Description)
		}
	} else {
		fmt.Fprintf(f.output, "%s\n\n", project.Title)
		fmt.Fprintf(f.output, "ID: %d\n", project.ID)
		fmt.Fprintf(f.output, "URI: %s\n", fmt.Sprintf("vikunja://projects/%d", project.ID))
		if project.Description != "" {
			fmt.Fprintf(f.output, "\nDescription:\n%s\n", project.Description)
		}
	}
	return nil
}

// FormatTasks formats a list of tasks as a table
func (f *Formatter) FormatTasks(tasks []Task) error {
	if f.useColor {
		headerColor := color.New(color.FgCyan, color.Bold)
		_, _ = fmt.Fprintln(f.output, headerColor.Sprint("TASKS"))
		_, _ = fmt.Fprintln(f.output)
	}

	w := tabwriter.NewWriter(f.output, 0, 0, 3, ' ', 0)

	if f.useColor {
		headerColor := color.New(color.FgYellow, color.Bold)
		_, _ = fmt.Fprintln(w, headerColor.Sprint("TITLE")+"\t"+headerColor.Sprint("ID")+"\t"+headerColor.Sprint("BUCKET")+"\t"+headerColor.Sprint("URI"))
	} else {
		_, _ = fmt.Fprintln(w, "TITLE\tID\tBUCKET\tURI")
	}

	for _, t := range tasks {
		uri := fmt.Sprintf("vikunja://tasks/%d", t.ID)
		bucket := "-"
		if len(t.Buckets) > 0 {
			bucket = t.Buckets[0].Title
		}
		fmt.Fprintf(w, "%s\t%d\t%s\t%s\n", t.Title, t.ID, bucket, uri)
	}

	return w.Flush()
}

// FormatTask formats a single task with full details
func (f *Formatter) FormatTask(task *Task) error {
	if f.useColor {
		titleColor := color.New(color.FgCyan, color.Bold)
		labelColor := color.New(color.FgYellow)
		fmt.Fprintf(f.output, "%s\n\n", titleColor.Sprint(task.Title))
		fmt.Fprintf(f.output, "%s %d\n", labelColor.Sprint("ID:"), task.ID)
		fmt.Fprintf(f.output, "%s %s\n", labelColor.Sprint("URI:"), fmt.Sprintf("vikunja://tasks/%d", task.ID))
		if task.ProjectID > 0 {
			fmt.Fprintf(f.output, "%s %d\n", labelColor.Sprint("Project ID:"), task.ProjectID)
		}
		if task.Description != "" {
			fmt.Fprintf(f.output, "\n%s\n%s\n", labelColor.Sprint("Description:"), task.Description)
		}
	} else {
		fmt.Fprintf(f.output, "%s\n\n", task.Title)
		fmt.Fprintf(f.output, "ID: %d\n", task.ID)
		fmt.Fprintf(f.output, "URI: %s\n", fmt.Sprintf("vikunja://tasks/%d", task.ID))
		if task.ProjectID > 0 {
			fmt.Fprintf(f.output, "Project ID: %d\n", task.ProjectID)
		}
		if task.Description != "" {
			fmt.Fprintf(f.output, "\nDescription:\n%s\n", task.Description)
		}
	}
	return nil
}

// FormatAsJSON formats data as JSON
func (f *Formatter) FormatAsJSON(v interface{}) error {
	encoder := json.NewEncoder(f.output)
	encoder.SetIndent("", "  ")
	return encoder.Encode(v)
}

// FormatProjectsAsJSON formats projects as JSON
func (f *Formatter) FormatProjectsAsJSON(projects []Project) error {
	return f.FormatAsJSON(projects)
}

// FormatProjectAsJSON formats a single project as JSON
func (f *Formatter) FormatProjectAsJSON(project *Project) error {
	return f.FormatAsJSON(project)
}

// FormatTasksAsJSON formats tasks as JSON
func (f *Formatter) FormatTasksAsJSON(tasks []Task) error {
	return f.FormatAsJSON(tasks)
}

// FormatTaskAsJSON formats a single task as JSON
func (f *Formatter) FormatTaskAsJSON(task *Task) error {
	return f.FormatAsJSON(task)
}

// FormatBuckets formats a list of buckets
func (f *Formatter) FormatBuckets(buckets []Bucket) error {
	w := tabwriter.NewWriter(f.output, 0, 0, 2, ' ', 0)

	headerColor := color.New(color.FgCyan, color.Bold)
	if !f.useColor {
		headerColor = color.New()
	}

	_, _ = fmt.Fprintln(w, headerColor.Sprint("TITLE")+"\t"+headerColor.Sprint("ID")+"\t"+headerColor.Sprint("DONE")+"\t"+headerColor.Sprint("POSITION"))

	for _, b := range buckets {
		done := "No"
		if b.IsDoneBucket {
			done = "Yes"
		}
		fmt.Fprintf(w, "%s\t%d\t%s\t%.2f\n", b.Title, b.ID, done, b.Position)
	}

	return w.Flush()
}

// FormatProjectViews formats a list of project views
func (f *Formatter) FormatProjectViews(views []ProjectView) error {
	w := tabwriter.NewWriter(f.output, 0, 0, 2, ' ', 0)

	headerColor := color.New(color.FgCyan, color.Bold)
	if !f.useColor {
		headerColor = color.New()
	}

	_, _ = fmt.Fprintln(w, headerColor.Sprint("TITLE")+"\t"+headerColor.Sprint("ID")+"\t"+headerColor.Sprint("KIND")+"\t"+headerColor.Sprint("POSITION"))

	for _, v := range views {
		fmt.Fprintf(w, "%s\t%d\t%s\t%.2f\n", v.Title, v.ID, v.ViewKind, v.Position)
	}

	return w.Flush()
}

// FormatTaskWithBuckets formats a single task with bucket information
func (f *Formatter) FormatTaskWithBuckets(task *Task, bucketInfo *TaskBucketInfo) error {
	if f.useColor {
		titleColor := color.New(color.FgCyan, color.Bold)
		labelColor := color.New(color.FgYellow)
		fmt.Fprintf(f.output, "%s\n\n", titleColor.Sprint(task.Title))
		fmt.Fprintf(f.output, "%s %d\n", labelColor.Sprint("ID:"), task.ID)
		fmt.Fprintf(f.output, "%s %s\n", labelColor.Sprint("URI:"), fmt.Sprintf("vikunja://tasks/%d", task.ID))
		if task.ProjectID > 0 {
			fmt.Fprintf(f.output, "%s %d\n", labelColor.Sprint("Project ID:"), task.ProjectID)
		}
		if task.Description != "" {
			fmt.Fprintf(f.output, "\n%s\n%s\n", labelColor.Sprint("Description:"), task.Description)
		}

		if bucketInfo != nil && len(bucketInfo.Views) > 0 {
			fmt.Fprintf(f.output, "\n%s\n", labelColor.Sprint("Bucket Information:"))
			for _, view := range bucketInfo.Views {
				if view.ViewKind == ViewKindKanban && view.BucketTitle != nil {
					doneMark := ""
					if view.IsDoneBucket {
						doneMark = " [DONE]"
					}
					fmt.Fprintf(f.output, "  %s (%s): %s%s\n",
						view.ViewTitle, view.ViewKind, *view.BucketTitle, doneMark)
				}
			}
		}
	} else {
		fmt.Fprintf(f.output, "%s\n\n", task.Title)
		fmt.Fprintf(f.output, "ID: %d\n", task.ID)
		fmt.Fprintf(f.output, "URI: %s\n", fmt.Sprintf("vikunja://tasks/%d", task.ID))
		if task.ProjectID > 0 {
			fmt.Fprintf(f.output, "Project ID: %d\n", task.ProjectID)
		}
		if task.Description != "" {
			fmt.Fprintf(f.output, "\nDescription:\n%s\n", task.Description)
		}

		if bucketInfo != nil && len(bucketInfo.Views) > 0 {
			fmt.Fprintf(f.output, "\nBucket Information:\n")
			for _, view := range bucketInfo.Views {
				if view.ViewKind == ViewKindKanban && view.BucketTitle != nil {
					doneMark := ""
					if view.IsDoneBucket {
						doneMark = " [DONE]"
					}
					fmt.Fprintf(f.output, "  %s (%s): %s%s\n",
						view.ViewTitle, view.ViewKind, *view.BucketTitle, doneMark)
				}
			}
		}
	}
	return nil
}

// FormatViewTasks formats a view with its buckets and tasks
func (f *Formatter) FormatViewTasks(vt *ViewTasks) error {
	titleColor := color.New(color.FgCyan, color.Bold)
	bucketColor := color.New(color.FgYellow, color.Bold)
	taskColor := color.New(color.FgWhite)
	doneColor := color.New(color.FgHiBlack)

	if !f.useColor {
		titleColor = color.New()
		bucketColor = color.New()
		taskColor = color.New()
		doneColor = color.New()
	}

	fmt.Fprintf(f.output, "%s (ID: %d)\n\n", titleColor.Sprint(vt.ViewTitle), vt.ViewID)

	for _, bt := range vt.Buckets {
		doneMark := ""
		if bt.Bucket.IsDoneBucket {
			doneMark = " [DONE]"
		}
		fmt.Fprintf(f.output, "%s (ID: %d)%s\n", bucketColor.Sprint(bt.Bucket.Title), bt.Bucket.ID, doneMark)

		if len(bt.Tasks) == 0 {
			fmt.Fprintf(f.output, "  (no tasks)\n")
		} else {
			for _, t := range bt.Tasks {
				tc := taskColor
				if t.Done {
					tc = doneColor
				}
				fmt.Fprintf(f.output, "  - [Task %d] %s\n", t.ID, tc.Sprint(t.Title))
			}
		}
		_, _ = fmt.Fprintln(f.output)
	}

	return nil
}

// CaptureOutput captures formatted output to a string
func (f *Formatter) CaptureOutput(fn func() error) (string, error) {
	buf := &bytes.Buffer{}
	oldOutput := f.output
	f.output = buf
	defer func() { f.output = oldOutput }()

	if err := fn(); err != nil {
		return "", err
	}
	return buf.String(), nil
}

// Markdown formatting methods

// FormatTasksAsMarkdown formats tasks as markdown
func (f *Formatter) FormatTasksAsMarkdown(tasks []Task) string {
	if len(tasks) == 0 {
		return "## No tasks found\n"
	}

	var buf strings.Builder
	buf.WriteString(fmt.Sprintf("## Tasks (%d)\n\n", len(tasks)))

	// Main task table
	buf.WriteString("| ID | Title | Done | Due Date | Project |\n")
	buf.WriteString("|---|---|---|---|---|\n")

	for _, task := range tasks {
		done := "‚ùå"
		if task.Done {
			done = "‚úÖ"
		}

		dueDate := "-"
		if !task.DueDate.IsZero() {
			dueDate = task.DueDate.Format("2006-01-02")
		}

		project := "-"
		if task.ProjectID > 0 {
			project = fmt.Sprintf("[%d](vikunja://projects/%d)", task.ProjectID, task.ProjectID)
		}

		title := strings.ReplaceAll(task.Title, "|", "\\|") // Escape pipe characters
		buf.WriteString(fmt.Sprintf("| %d | %s | %s | %s | %s |\n",
			task.ID, title, done, dueDate, project))
	}

	buf.WriteString("\n<details>\n<summary>Task Details</summary>\n\n")
	for _, task := range tasks {
		buf.WriteString(f.formatTaskDetailsMarkdown(task))
	}
	buf.WriteString("</details>\n")

	return buf.String()
}

// FormatTaskAsMarkdown formats a single task as markdown
func (f *Formatter) FormatTaskAsMarkdown(task Task) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# %s\n\n", task.Title))
	buf.WriteString(f.formatTaskDetailsMarkdown(task))

	return buf.String()
}

// formatTaskDetailsMarkdown formats detailed task information
func (f *Formatter) formatTaskDetailsMarkdown(task Task) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("### %s\n\n", task.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", task.ID))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://tasks/%d](vikunja://tasks/%d)\n", task.ID, task.ID))

	if task.ProjectID > 0 {
		buf.WriteString(fmt.Sprintf("- **Project**: [%d](vikunja://projects/%d)\n", task.ProjectID, task.ProjectID))
	}

	if !task.Created.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Created**: %s\n", task.Created.Format(time.RFC3339)))
	}

	if !task.Updated.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Updated**: %s\n", task.Updated.Format(time.RFC3339)))
	}

	if !task.DueDate.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Due Date**: %s\n", task.DueDate.Format("2006-01-02")))
	}

	if task.Done {
		buf.WriteString("- **Status**: ‚úÖ Completed\n")
	} else {
		buf.WriteString("- **Status**: ‚ùå Pending\n")
	}

	if task.Description != "" {
		buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", task.Description))
	}

	buf.WriteString("\n---\n\n")
	return buf.String()
}

// FormatProjectsAsMarkdown formats projects as markdown
func (f *Formatter) FormatProjectsAsMarkdown(projects []Project) string {
	if len(projects) == 0 {
		return "# No projects found\n"
	}

	var buf strings.Builder
	buf.WriteString(fmt.Sprintf("# Projects (%d)\n\n", len(projects)))

	for _, project := range projects {
		buf.WriteString(fmt.Sprintf("## üìÅ %s\n\n", project.Title))
		buf.WriteString(fmt.Sprintf("- **ID**: %d\n", project.ID))
		buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://projects/%d](vikunja://projects/%d)\n", project.ID, project.ID))

		if project.Identifier != "" && strings.TrimSpace(project.Identifier) != "" {
			buf.WriteString(fmt.Sprintf("- **Identifier**: `%s`\n", project.Identifier))
		}

		if !project.Created.IsZero() && project.Created.Year() > 1970 {
			buf.WriteString(fmt.Sprintf("- **Created**: %s\n", project.Created.Format("2006-01-02")))
		}

		if project.Description != "" && strings.TrimSpace(project.Description) != "" {
			buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", project.Description))
		}

		buf.WriteString("\n---\n\n")
	}

	return buf.String()
}

// FormatProjectAsMarkdown formats a single project as markdown
func (f *Formatter) FormatProjectAsMarkdown(project Project) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# %s\n\n", project.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", project.ID))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://projects/%d](vikunja://projects/%d)\n", project.ID, project.ID))

	if project.Identifier != "" {
		buf.WriteString(fmt.Sprintf("- **Identifier**: `%s`\n", project.Identifier))
	}

	if project.OwnerID > 0 {
		buf.WriteString(fmt.Sprintf("- **Owner ID**: %d\n", project.OwnerID))
	}

	if !project.Created.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Created**: %s\n", project.Created.Format(time.RFC3339)))
	}

	if !project.Updated.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Updated**: %s\n", project.Updated.Format(time.RFC3339)))
	}

	if project.Description != "" {
		buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", project.Description))
	}

	return buf.String()
}

// FormatBucketsAsMarkdown formats buckets as markdown
func (f *Formatter) FormatBucketsAsMarkdown(buckets []Bucket) string {
	if len(buckets) == 0 {
		return "## No buckets found\n"
	}

	var buf strings.Builder
	buf.WriteString(fmt.Sprintf("## üìã Buckets (%d)\n\n", len(buckets)))

	buf.WriteString("| üìÅ Bucket | ID | Tasks | Limit | Done |\n")
	buf.WriteString("|---|---|---|---|---|\n")

	for _, bucket := range buckets {
		taskCount := len(bucket.Tasks)
		limit := "-"
		if bucket.Limit > 0 {
			limit = fmt.Sprintf("%d", bucket.Limit)
		}

		done := "‚ùå"
		if bucket.IsDoneBucket {
			done = "‚úÖ"
		}

		title := strings.ReplaceAll(bucket.Title, "|", "\\|") // Escape pipe characters
		buf.WriteString(fmt.Sprintf("| %s | %d | %d | %s | %s |\n",
			title, bucket.ID, taskCount, limit, done))
	}

	return buf.String()
}

// FormatViewAsMarkdown formats a project view as markdown
func (f *Formatter) FormatViewAsMarkdown(view ProjectView) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# %s\n\n", view.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", view.ID))
	buf.WriteString(fmt.Sprintf("- **Project ID**: %d\n", view.ProjectID))
	buf.WriteString(fmt.Sprintf("- **Type**: %s\n", view.ViewKind))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://views/%d](vikunja://views/%d)\n", view.ID, view.ID))
	buf.WriteString(fmt.Sprintf("- **Position**: %.2f\n", view.Position))

	if view.DefaultBucketID > 0 {
		buf.WriteString(fmt.Sprintf("- **Default Bucket**: %d\n", view.DefaultBucketID))
	}

	if view.DoneBucketID > 0 {
		buf.WriteString(fmt.Sprintf("- **Done Bucket**: %d\n", view.DoneBucketID))
	}

	return buf.String()
}

// FormatViewTasksAsMarkdown formats a view with buckets and tasks as markdown
func (f *Formatter) FormatViewTasksAsMarkdown(vt *ViewTasks) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# %s (ID: %d)\n\n", vt.ViewTitle, vt.ViewID))

	for _, bt := range vt.Buckets {
		doneMark := ""
		if bt.Bucket.IsDoneBucket {
			doneMark = " ‚úÖ"
		}

		buf.WriteString(fmt.Sprintf("## %s (ID: %d)%s\n\n", bt.Bucket.Title, bt.Bucket.ID, doneMark))

		if len(bt.Tasks) == 0 {
			buf.WriteString("(no tasks)\n\n")
		} else {
			for _, task := range bt.Tasks {
				status := "‚ùå"
				if task.Done {
					status = "‚úÖ"
				}

				title := strings.ReplaceAll(task.Title, "|", "\\|") // Escape pipe characters
				buf.WriteString(fmt.Sprintf("- %s [Task %d] %s\n", status, task.ID, title))
			}
			buf.WriteString("\n")
		}
	}

	return buf.String()
}

// FormatViewTasksSummaryAsMarkdown formats a view with buckets and tasks summary as markdown
func (f *Formatter) FormatViewTasksSummaryAsMarkdown(vt *ViewTasksSummary) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# üìã %s (ID: %d)\n\n", vt.ViewTitle, vt.ViewID))

	for _, bt := range vt.Buckets {
		doneMark := ""
		// Note: BucketSummary doesn't have IsDoneBucket field, so we can't check it here

		buf.WriteString(fmt.Sprintf("## üìÅ %s (ID: %d)%s\n\n", bt.Bucket.Title, bt.Bucket.ID, doneMark))

		if len(bt.Tasks) == 0 {
			buf.WriteString("(no tasks)\n\n")
		} else {
			for _, task := range bt.Tasks {
				// Note: TaskSummary doesn't have Done field, so we can't check completion status

				title := strings.ReplaceAll(task.Title, "|", "\\|") // Escape pipe characters
				buf.WriteString(fmt.Sprintf("- [Task %d] %s\n", task.ID, title))
			}
			buf.WriteString("\n")
		}
	}

	return buf.String()
}

// FormatTaskWithBucketsMarkdown formats a task with bucket information as markdown
func (f *Formatter) FormatTaskWithBucketsMarkdown(task Task, bucketInfo *TaskBucketInfo) string {
	var buf strings.Builder

	buf.WriteString(fmt.Sprintf("# %s\n\n", task.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", task.ID))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://tasks/%d](vikunja://tasks/%d)\n", task.ID, task.ID))

	if task.ProjectID > 0 {
		buf.WriteString(fmt.Sprintf("- **Project**: [%d](vikunja://projects/%d)\n", task.ProjectID, task.ProjectID))
	}

	if !task.Created.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Created**: %s\n", task.Created.Format(time.RFC3339)))
	}

	if !task.Updated.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Updated**: %s\n", task.Updated.Format(time.RFC3339)))
	}

	if !task.DueDate.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Due Date**: %s\n", task.DueDate.Format("2006-01-02")))
	}

	if task.Done {
		buf.WriteString("- **Status**: ‚úÖ Completed\n")
	} else {
		buf.WriteString("- **Status**: ‚ùå Pending\n")
	}

	if task.Description != "" {
		buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", task.Description))
	}

	if bucketInfo != nil && len(bucketInfo.Views) > 0 {
		buf.WriteString("\n**Bucket Information**:\n")
		for _, view := range bucketInfo.Views {
			if view.ViewKind == ViewKindKanban && view.BucketTitle != nil {
				doneMark := ""
				if view.IsDoneBucket {
					doneMark = " ‚úÖ"
				}
				buf.WriteString(fmt.Sprintf("- %s (%s): %s%s\n",
					view.ViewTitle, view.ViewKind, *view.BucketTitle, doneMark))
			}
		}
	}

	return buf.String()
}

// FormatProjectAndViewMarkdown formats a project and view as markdown
func (f *Formatter) FormatProjectAndViewMarkdown(project Project, view ProjectView) string {
	var buf strings.Builder

	// Project section
	buf.WriteString(fmt.Sprintf("# üìÅ %s\n\n", project.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", project.ID))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://projects/%d](vikunja://projects/%d)\n", project.ID, project.ID))

	if project.Identifier != "" {
		buf.WriteString(fmt.Sprintf("- **Identifier**: `%s`\n", project.Identifier))
	}

	if project.OwnerID > 0 {
		buf.WriteString(fmt.Sprintf("- **Owner ID**: %d\n", project.OwnerID))
	}

	if !project.Created.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Created**: %s\n", project.Created.Format(time.RFC3339)))
	}

	if !project.Updated.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Updated**: %s\n", project.Updated.Format(time.RFC3339)))
	}

	if project.Description != "" {
		buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", project.Description))
	}

	// View section
	buf.WriteString("\n---\n\n")
	buf.WriteString(f.FormatViewAsMarkdown(view))

	return buf.String()
}

// FormatProjectAndViewListMarkdown formats a project and multiple views as markdown
func (f *Formatter) FormatProjectAndViewListMarkdown(project Project, views []ProjectView) string {
	var buf strings.Builder

	// Project section
	buf.WriteString(fmt.Sprintf("# üìÅ %s\n\n", project.Title))
	buf.WriteString(fmt.Sprintf("- **ID**: %d\n", project.ID))
	buf.WriteString(fmt.Sprintf("- **URI**: [vikunja://projects/%d](vikunja://projects/%d)\n", project.ID, project.ID))

	if project.Identifier != "" {
		buf.WriteString(fmt.Sprintf("- **Identifier**: `%s`\n", project.Identifier))
	}

	if project.OwnerID > 0 {
		buf.WriteString(fmt.Sprintf("- **Owner ID**: %d\n", project.OwnerID))
	}

	if !project.Created.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Created**: %s\n", project.Created.Format(time.RFC3339)))
	}

	if !project.Updated.IsZero() {
		buf.WriteString(fmt.Sprintf("- **Updated**: %s\n", project.Updated.Format(time.RFC3339)))
	}

	if project.Description != "" {
		buf.WriteString(fmt.Sprintf("\n**Description**:\n%s\n", project.Description))
	}

	// Views section
	buf.WriteString(fmt.Sprintf("\n## Views (%d)\n\n", len(views)))
	buf.WriteString("| üìã View | ID | Type | Position |\n")
	buf.WriteString("|---|---|---|---|\n")

	for _, view := range views {
		title := strings.ReplaceAll(view.Title, "|", "\\|") // Escape pipe characters

		// Add emoji based on view type
		viewEmoji := ""
		switch view.ViewKind {
		case ViewKindKanban:
			viewEmoji = "üìã "
		case ViewKindList:
			viewEmoji = "üìù "
		case ViewKindGantt:
			viewEmoji = "üìä "
		}

		buf.WriteString(fmt.Sprintf("| %s%s | %d | %s | %.2f |\n", viewEmoji, title, view.ID, view.ViewKind, view.Position))
	}

	return buf.String()
}
