# CI/CD workflow for MCP Vikunja
# Consolidated single workflow handling all scenarios without duplication

name: CI/CD

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  GO_VERSION: '1.24'

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Install goimports
        run: go install golang.org/x/tools/cmd/goimports@latest

      - name: Check formatting
        run: |
          unformatted=$(gofmt -l .)
          if [ -n "$unformatted" ]; then
            echo "‚ùå Code is not formatted. Run 'go fmt ./...'"
            echo "$unformatted"
            exit 1
          fi
          echo "‚úÖ Code formatting OK"

      - name: Check imports
        run: |
          unformatted=$(goimports -l .)
          if [ -n "$unformatted" ]; then
            echo "‚ùå Imports need formatting. Run 'goimports -w .'"
            echo "$unformatted"
            exit 1
          fi
          echo "‚úÖ Imports formatting OK"

#      - name: Run golangci-lint
#        uses: golangci/golangci-lint-action@v6
#        with:
#          version: latest
#          args: --timeout=10m

      - name: Run go vet
        run: go vet ./...

  test:
    name: Test
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      matrix:
        go-version: ['1.24', '1.25']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Download dependencies
        run: go mod download

      - name: Run tests with coverage
        run: |
          # Check if internal and pkg directories exist
          has_internal=false
          has_pkg=false
          coverage_packages=""

          if [ -d "internal" ]; then
            has_internal=true
            coverage_packages="${coverage_packages} ./internal/..."
          fi

          if [ -d "pkg" ]; then
            has_pkg=true
            coverage_packages="${coverage_packages} ./pkg/..."
          fi

          if [ -n "$coverage_packages" ]; then
            echo "üìä Running coverage on: $coverage_packages"
            go test -race -coverprofile=coverage.out $coverage_packages
          else
            echo "üìä Running coverage on all packages"
            go test -race -coverprofile=coverage.out ./...
          fi

      - name: Verify coverage threshold
        run: |
          coverage=$(go tool cover -func=coverage.out | grep total | awk '{print $3}' | sed 's/%//')
          echo "Total coverage: ${coverage}%"
          if (( $(echo "$coverage < 60" | bc -l) )); then
            echo "‚ùå Coverage below 60%"
            exit 1
          fi
          echo "‚úÖ Coverage threshold met"

  build:
    name: Build
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [validate, test]
    strategy:
      matrix:
        go-version: ['1.24', '1.25']
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go ${{ matrix.go-version }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}

      - name: Build mcp-vikunja
        run: go build -o bin/mcp-vikunja ./cmd/mcp-vikunja

      - name: Build vikunja-cli
        run: go build -o bin/vikunja-cli ./cmd/vikunja-cli

      - name: Verify binaries
        run: |
          ls -lh bin/
          test -f bin/mcp-vikunja
          test -f bin/vikunja-cli
          echo "‚úÖ Both binaries built successfully"

  release:
    name: Release
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [validate, test, build]
    # Only release on main branch pushes by @meschbach
    if: github.event_name == 'push' && github.ref == 'refs/heads/main' && github.actor == 'meschbach'
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Bump version and push tag
        uses: anothrNick/github-tag-action@v1
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          WITH_V: true
          DEFAULT_BUMP: patch
          DRY_RUN: true
      - name: Build release artifacts
        run: |
          chmod +x release.sh
          ./release.sh

      - name: Push version tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ steps.version.outputs.tag }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          fail_on_unmatched_files: true
          generate_release_notes: true
          files: |
            release/mcp-vikunja_*.tgz

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Build and push slacker
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: "linux/amd64,linux/arm64"
          file: cmd/mcp-vinkunja/Dockerfile
          push: true
          tags: |
            ghcr.io/${{ github.repository }}:${{ steps.version.outputs.tag }}
      - name: Generate release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.version.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          ls -lh release/mcp-vikunja_*.tgz | awk '{print "- " $9 " (" $5 ")"}' >> $GITHUB_STEP_SUMMARY

  status:
    name: Status Check
    runs-on: ubuntu-latest
    needs: [validate, test, build, release]
    if: always()
    steps:
      - name: Check workflow status
        run: |
          if [ "${{ needs.validate.result }}" == "failure" ] || \
             [ "${{ needs.test.result }}" == "failure" ] || \
             [ "${{ needs.build.result }}" == "failure" ]; then
            echo "‚ùå Required jobs failed"
            exit 1
          fi
          
          if [ "${{ needs.release.result }}" == "failure" ]; then
            echo "‚ùå Release job failed"
            exit 1
          fi
          
          echo "‚úÖ All jobs completed successfully"
